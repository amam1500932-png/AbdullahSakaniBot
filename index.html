<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classic Code Editor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/monokai.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="editor-container">
        <div class="toolbar">
            <div class="toolbar-left">
                <span class="logo">Code Editor</span>
            </div>
            <div class="toolbar-center">
                <input type="text" id="filename" placeholder="filename.py" value="untitled.py">
                <select id="language">
                    <option value="python">Python</option>
                    <option value="javascript">JavaScript</option>
                    <option value="htmlmixed">HTML</option>
                    <option value="css">CSS</option>
                    <option value="xml">XML</option>
                    <option value="markdown">Markdown</option>
                    <option value="sql">SQL</option>
                    <option value="clike">C/C++/Java</option>
                </select>
            </div>
            <div class="toolbar-right">
                <button id="newBtn" class="btn">New</button>
                <button id="saveBtn" class="btn btn-primary">Save</button>
                <button id="loadBtn" class="btn">Open</button>
            </div>
        </div>
        
        <div class="main-area">
            <div class="sidebar">
                <div class="sidebar-header">Files</div>
                <ul id="fileList"></ul>
            </div>
            <div class="editor-wrapper">
                <textarea id="editor"></textarea>
            </div>
        </div>
        
        <div class="statusbar">
            <span id="status">Ready</span>
            <span id="position">Line 1, Col 1</span>
        </div>
    </div>

    <div id="modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">Open File</div>
            <div class="modal-body">
                <input type="text" id="openFilename" placeholder="Enter filename to open">
            </div>
            <div class="modal-footer">
                <button id="modalCancel" class="btn">Cancel</button>
                <button id="modalOpen" class="btn btn-primary">Open</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/markdown/markdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/sql/sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/clike/clike.min.js"></script>

    <script>
        const editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
            mode: 'python',
            theme: 'monokai',
            lineNumbers: true,
            indentUnit: 4,
            tabSize: 4,
            indentWithTabs: false,
            lineWrapping: false,
            matchBrackets: true,
            autoCloseBrackets: true,
            styleActiveLine: true
        });

        editor.setSize('100%', '100%');

        const filenameInput = document.getElementById('filename');
        const languageSelect = document.getElementById('language');
        const statusSpan = document.getElementById('status');
        const positionSpan = document.getElementById('position');
        const fileList = document.getElementById('fileList');
        const modal = document.getElementById('modal');
        const openFilenameInput = document.getElementById('openFilename');

        languageSelect.addEventListener('change', function() {
            editor.setOption('mode', this.value);
        });

        editor.on('cursorActivity', function() {
            const cursor = editor.getCursor();
            positionSpan.textContent = `Line ${cursor.line + 1}, Col ${cursor.ch + 1}`;
        });

        document.getElementById('newBtn').addEventListener('click', function() {
            editor.setValue('');
            filenameInput.value = 'untitled.py';
            languageSelect.value = 'python';
            editor.setOption('mode', 'python');
            setStatus('New file created');
        });

        document.getElementById('saveBtn').addEventListener('click', async function() {
            const filename = filenameInput.value || 'untitled.txt';
            const content = editor.getValue();
            
            try {
                const response = await fetch('/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename, content })
                });
                const data = await response.json();
                if (data.success) {
                    setStatus(`Saved: ${data.filename}`);
                    loadFileList();
                } else {
                    setStatus('Error saving file');
                }
            } catch (err) {
                setStatus('Error saving file');
            }
        });

        document.getElementById('loadBtn').addEventListener('click', function() {
            modal.classList.remove('hidden');
            openFilenameInput.value = '';
            openFilenameInput.focus();
        });

        document.getElementById('modalCancel').addEventListener('click', function() {
            modal.classList.add('hidden');
        });

        document.getElementById('modalOpen').addEventListener('click', async function() {
            const filename = openFilenameInput.value;
            if (filename) {
                await openFile(filename);
                modal.classList.add('hidden');
            }
        });

        openFilenameInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('modalOpen').click();
            }
        });

        async function openFile(filename) {
            try {
                const response = await fetch('/load', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename })
                });
                const data = await response.json();
                if (data.success) {
                    editor.setValue(data.content);
                    filenameInput.value = filename;
                    detectLanguage(filename);
                    setStatus(`Opened: ${filename}`);
                } else {
                    setStatus('File not found');
                }
            } catch (err) {
                setStatus('Error loading file');
            }
        }

        function detectLanguage(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const modeMap = {
                'py': 'python',
                'js': 'javascript',
                'html': 'htmlmixed',
                'htm': 'htmlmixed',
                'css': 'css',
                'xml': 'xml',
                'md': 'markdown',
                'sql': 'sql',
                'c': 'clike',
                'cpp': 'clike',
                'java': 'clike',
                'h': 'clike'
            };
            const mode = modeMap[ext] || 'python';
            languageSelect.value = mode;
            editor.setOption('mode', mode);
        }

        async function loadFileList() {
            try {
                const response = await fetch('/files');
                const data = await response.json();
                fileList.innerHTML = '';
                data.files.forEach(file => {
                    const li = document.createElement('li');
                    li.textContent = file;
                    li.addEventListener('click', () => openFile(file));
                    fileList.appendChild(li);
                });
            } catch (err) {
                console.error('Error loading file list');
            }
        }

        function setStatus(message) {
            statusSpan.textContent = message;
        }

        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                document.getElementById('saveBtn').click();
            }
        });

        loadFileList();
    </script>
</body>
</html>
